<Page x:Class="SerialApp.Pages.CommandPage"
      xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
      xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
      xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
      xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
      xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
      xmlns:vm="clr-namespace:SerialApp.ViewModels"
      mc:Ignorable="d" 
      d:DesignHeight="600" d:DesignWidth="800"
      Title="CommandPage">

    <Page.DataContext>
        <vm:CommandViewModel/>
    </Page.DataContext>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <!-- 0: 操作パネルエリア -->
            <RowDefinition Height="Auto"/>
            <!-- 1: 余白 -->
            <RowDefinition Height="20"/>
            <!-- 2: ログ表示エリア -->
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- 上部：操作パネル (Cardで囲ってグルーピング) -->
        <ui:Card Grid.Row="0" VerticalAlignment="Top">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="10"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>
                
                <!-- 1段目: アドレスとコマンド -->
                <Grid Grid.Row="0">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/> <!-- アドレスラベル -->
                        <ColumnDefinition Width="100"/>  <!-- アドレスCombo -->
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/> <!-- コマンドラベル -->
                        <ColumnDefinition Width="*"/>    <!-- コマンドInput -->
                        <ColumnDefinition Width="10"/>
                        <ColumnDefinition Width="Auto"/> <!-- 送信ボタン -->
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="アドレス:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <ComboBox Grid.Column="1" 
                              ItemsSource="{Binding AddressList}" 
                              SelectedItem="{Binding SelectedAddress}"
                              HorizontalAlignment="Stretch"/>

                    <TextBlock Grid.Column="3" Text="コマンド:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    <ui:TextBox Grid.Column="4" 
                                Text="{Binding CommandText, UpdateSourceTrigger=PropertyChanged}"
                                PlaceholderText="コマンドを入力..." 
                                HorizontalAlignment="Stretch"/>

                    <ui:Button Grid.Column="6" 
                               Content="単発送信" 
                               Icon="{ui:SymbolIcon Send24}" 
                               Appearance="Primary"
                               Command="{Binding SendSingleCommand}"/>
                </Grid>

                <!-- 2段目: 連続送信設定 -->
                <Grid Grid.Row="2">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="120"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="20"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="インターバル:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                    
                    <!-- 数値入力 (簡易的にTextBoxを使用) -->
                    <ui:TextBox Grid.Column="1" 
                                Text="{Binding IntervalValue, UpdateSourceTrigger=PropertyChanged}"
                                PlaceholderText="500-5000"/>
                    
                    <TextBlock Grid.Column="2" Text="ms" VerticalAlignment="Center" Margin="5,0,0,0"/>

                    <!-- 連続送信ボタン (トグル動作) -->
                    <!-- IsContinuousSendingがTrueのときは赤色(Caution)などで停止を示すと良いが、ここではテキストを変更 -->
                    <ui:Button Grid.Column="4" 
                               Command="{Binding ToggleContinuousCommand}"
                               Icon="{ui:SymbolIcon ArrowRepeatAll24}">
                        <ui:Button.Style>
                            <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                <Setter Property="Content" Value="連続送信 開始"/>
                                <Setter Property="Appearance" Value="Secondary"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding IsContinuousSending}" Value="True">
                                        <Setter Property="Content" Value="連続送信 停止"/>
                                        <Setter Property="Appearance" Value="Caution"/> <!-- 停止ボタンは目立つ色に -->
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </ui:Button.Style>
                    </ui:Button>
                </Grid>
            </Grid>
        </ui:Card>

        <!-- 下部：ログ表示エリア (左右分割) -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="10"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- 左側: 送信ログ -->
            <GroupBox Grid.Column="0" Header="送信データ">
                <!-- 
                     ScrollViewer.ScrollChangedイベントをハンドルして自動スクロールを実装します。
                     VirtualizingStackPanel.IsVirtualizing="True" でパフォーマンスを確保。
                -->
                <ListBox x:Name="SendLogList" 
                         ItemsSource="{Binding SendLogs}"
                         ScrollViewer.ScrollChanged="OnLogScrollChanged"
                         VirtualizingStackPanel.IsVirtualizing="True">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding DisplayText}" Foreground="LightGreen"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </GroupBox>

            <!-- 右側: 受信ログ -->
            <GroupBox Grid.Column="2" Header="受信データ">
                <ListBox x:Name="ReceiveLogList" 
                         ItemsSource="{Binding ReceiveLogs}"
                         ScrollViewer.ScrollChanged="OnLogScrollChanged"
                         VirtualizingStackPanel.IsVirtualizing="True">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding DisplayText}" Foreground="LightSkyBlue"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </GroupBox>
        </Grid>
    </Grid>
</Page>



